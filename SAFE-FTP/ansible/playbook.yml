- name: Configure secure FTP server with vsftpd
  hosts: safe_ftp
  become: true
  vars:
    ftp_users:
      - { name: "luis", files: ["luis1.txt", "luis2.txt"], chroot: yes }
      - { name: "maria", files: ["maria1.txt", "maria2.txt"], chroot: no }
      - { name: "miguel", files: [], chroot: yes }
    ftp_anonymous: yes
    ftp_cert: "/etc/ssl/certs/example.test.pem"
    ftp_port: 21
    ftp_data_port: 20
    ftp_idle_timeout: 720
    ftp_max_connections: 15
    ftp_bandwidth_local: 5
    ftp_bandwidth_anonymous: 2
    ftp_welcome: "--- Welcome to the FTP server of 'sistema.sol' ---"
    ftp_anon_welcome: "--- You have accessed the public directory server of 'sistema.sol' ---"

  tasks:

  - name: Update apt cache
    apt:
      update_cache: yes

  - name: Install vsftpd and FTP client
    apt:
      name:
        - vsftpd
        - ftp
      state: present
  - name: Copy resolv.conf
    ansible.builtin.copy:
      src: files/resolv.conf
      dest: /etc/resolv.conf
      owner: root
      group: root
      mode: '0644'

  - name: Ensure /srv/ftp exists
    file:
      path: /srv/ftp
      state: directory
      owner: root
      group: ftp
      mode: '0755'

  - name: Backup default vsftpd.conf
    copy:
      src: /etc/vsftpd.conf
      dest: /etc/vsftpd.conf.backup
      remote_src: yes
      owner: root
      group: root
      mode: '0644'

  - name: Configure vsftpd.conf
    copy:
      dest: /etc/vsftpd.conf
      content: |
        # 1. Standalone mode with IPv4
        listen=YES
        listen_ipv6=NO

        # 2. FTP server welcome message
        ftpd_banner={{ ftp_welcome }}

        # 3. Anonymous access
        anonymous_enable={{ "YES" if ftp_anonymous else "NO" }}
        anon_root=/srv/ftp
        anon_upload_enable=NO
        anon_mkdir_write_enable=NO
        anon_other_write_enable=NO

        # 4. Local users
        local_enable=YES
        write_enable=YES
        chroot_local_user=YES
        allow_writeable_chroot=YES
        user_sub_token=$USER

        # Exception for maria
        user_config_dir=/etc/vsftpd_user_conf

        # 5. FTP Ports
        connect_from_port_20=YES
        pasv_enable=YES
        pasv_min_port=30000
        pasv_max_port=30100

        # 6. Timeouts & limits
        idle_session_timeout={{ ftp_idle_timeout }}
        max_clients={{ ftp_max_connections }}
        local_max_rate={{ ftp_bandwidth_local * 1024 * 1024 }}
        anon_max_rate={{ ftp_bandwidth_anonymous * 1024 * 1024 }}

        # 7. SSL/TLS
        ssl_enable=YES
        allow_anon_ssl=YES
        force_local_data_ssl=YES
        force_local_logins_ssl=YES
        ssl_tlsv1=YES
        ssl_sslv2=NO
        ssl_sslv3=YES
        rsa_cert_file={{ ftp_cert }}
        require_ssl_reuse=NO

        # Logging
        xferlog_enable=YES
        xferlog_file=/var/log/vsftpd.log
        xferlog_std_format=YES
        log_ftp_protocol=YES

  - name: Ensure vsftpd user configuration directory exists
    file:
      path: /etc/vsftpd_user_conf
      state: directory
      owner: root
      group: root
      mode: '0755'

  - name: Create user-specific configuration for maria
    copy:
      dest: /etc/vsftpd_user_conf/maria
      content: |
        chroot_local_user=NO

  - name: Create local FTP users
    user:
      name: "{{ item.name }}"
      password: "{{ 'password' | password_hash('sha512') }}"
      shell: /bin/bash
      state: present
    loop: "{{ ftp_users }}"

  - name: Create home files for users
    copy:
      dest: "/home/{{ item.0.name }}/{{ item.1 }}"
      content: "This is {{ item.1 }} for {{ item.0.name }}."
      owner: "{{ item.0.name }}"
      group: "{{ item.0.name }}"
      mode: '0644'
    loop: "{{ ftp_users | subelements('files') }}"
    when: item.1 is defined

  - name: Restart vsftpd service
    service:
      name: vsftpd
      state: restarted
      enabled: yes

  - name: Ensure vsftpd is listening on port 21
    wait_for:
      host: 0.0.0.0
      port: "{{ ftp_port }}"
      timeout: 10

  - name: Ensure FTP data port 20 is allowed in firewall
    ufw:
      rule: allow
      port: "{{ ftp_data_port }}"
      proto: tcp
