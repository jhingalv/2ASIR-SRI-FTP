- name: Configure secure FTP server with vsftpd
  hosts: safe_ftp
  become: true
  vars:
    ftp_users:
      - { name: "luis", files: ["luis1.txt", "luis2.txt"], chroot: true }
      - { name: "maria", files: ["maria1.txt", "maria2.txt"], chroot: false }
      - { name: "miguel", files: [], chroot: true }
    ftp_anonymous: true
    ftp_cert: "/etc/ssl/certs/example.test.pem"
    ftp_port: 21
    ftp_data_port: 20
    ftp_idle_timeout: 720
    ftp_max_connections: 15
    ftp_bandwidth_local: 5
    ftp_bandwidth_anonymous: 2
    ftp_welcome: "--- Welcome to the FTP server of 'sistema.sol' ---"
    ftp_anon_welcome: "--- You have accessed the public directory server of 'sistema.sol' ---"
    ftp_pasv_ip: "192.168.56.20"

  tasks:
    - name: Copy resolv.conf
      ansible.builtin.copy:
        src: files/resolv.conf
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: '0644'

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install vsftpd, FTP client, openssl, and ufw
      ansible.builtin.apt:
        name:
          - vsftpd
          - ftp
          - openssl
          - ufw
        state: present

    - name: Ensure /srv/ftp exists
      ansible.builtin.file:
        path: /srv/ftp
        state: directory
        owner: root
        group: ftp
        mode: '0755'

    - name: Backup default vsftpd.conf
      ansible.builtin.copy:
        src: /etc/vsftpd.conf
        dest: /etc/vsftpd.conf.backup
        remote_src: true
        owner: root
        group: root
        mode: '0644'

    - name: Create SSL certificate for FTPS if not exists
      ansible.builtin.command: >
        openssl req -x509 -nodes -days 365
        -newkey rsa:2048
        -keyout {{ ftp_cert }}
        -out {{ ftp_cert }}
        -subj "/C=ES/ST=Granada/L=Granada/O=FTP_LAB/OU=Amador_y_Alvaro/CN=ftp.sistema.sol"
      args:
        creates: "{{ ftp_cert }}"
      notify: Restart vsftpd

    - name: Configure vsftpd.conf
      ansible.builtin.copy:
        dest: /etc/vsftpd.conf
        content: |
          listen=YES
          listen_ipv6=NO
          ftpd_banner={{ ftp_welcome }}
          guest_enable=YES
          guest_username=ftp
          anonymous_enable={{ "YES" if ftp_anonymous else "NO" }}
          anon_root=/srv/ftp
          anon_upload_enable=NO
          anon_mkdir_write_enable=NO
          anon_other_write_enable=NO
          local_enable=YES
          write_enable=YES
          chroot_local_user=YES
          allow_writeable_chroot=YES
          user_sub_token=$USER
          local_root=/home/$USER/files
          user_config_dir=/etc/vsftpd_user_conf
          connect_from_port_20=YES
          pasv_enable=YES
          pasv_min_port=30000
          pasv_max_port=30100
          pasv_address={{ ftp_pasv_ip }}
          idle_session_timeout={{ ftp_idle_timeout }}
          max_clients={{ ftp_max_connections }}
          local_max_rate={{ ftp_bandwidth_local * 1024 * 1024 }}
          anon_max_rate={{ ftp_bandwidth_anonymous * 1024 * 1024 }}
          xferlog_enable=YES
          xferlog_file=/var/log/vsftpd.log
          xferlog_std_format=YES
          log_ftp_protocol=YES
          ssl_enable=YES
          allow_anon_ssl=YES
          force_local_data_ssl=YES
          force_local_logins_ssl=YES
          rsa_cert_file={{ ftp_cert }}
          require_ssl_reuse=NO
          userlist_enable=YES
          userlist_deny=YES
          userlist_file=/etc/vsftpd.user_list
        owner: root
        group: root
        mode: '0644'
      notify: Restart vsftpd

    - name: Ensure vsftpd user configuration directory exists
      ansible.builtin.file:
        path: /etc/vsftpd_user_conf
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create user-specific configuration for maria (no chroot)
      ansible.builtin.copy:
        dest: /etc/vsftpd_user_conf/maria
        content: "chroot_local_user=NO"
        owner: root
        group: root
        mode: '0644'

    - name: Create local FTP users
      ansible.builtin.user:
        name: "{{ item.name }}"
        password: "{{ 'password' | password_hash('sha512') }}"
        shell: /bin/bash
        create_home: true
        state: present
      loop: "{{ ftp_users }}"

    - name: Fix home directory permissions for FTP chroot
      ansible.builtin.file:
        path: "/home/{{ item.name }}"
        owner: root
        group: root
        mode: '0755'
      loop: "{{ ftp_users }}"
      when: item.chroot

    - name: Create FTP data directory for users
      ansible.builtin.file:
        path: "/home/{{ item.name }}/files"
        state: directory
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0755'
      loop: "{{ ftp_users }}"

    - name: Create home files for users
      ansible.builtin.copy:
        dest: "/home/{{ item.0.name }}/files/{{ item.1 }}"
        content: "This is {{ item.1 }} for {{ item.0.name }}."
        owner: "{{ item.0.name }}"
        group: "{{ item.0.name }}"
        mode: '0644'
      loop: "{{ ftp_users | subelements('files') }}"

    - name: Fix home directory permissions for non-chroot users
      ansible.builtin.file:
        path: "/home/{{ item.name }}"
        owner: "{{ item.name }}"
        group: "{{ item.name }}"
        mode: '0755'
      loop: "{{ ftp_users }}"
      when: not item.chroot
      notify: Restart vsftpd

    - name: Open FTP ports in UFW
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - 21
        - 20
        - "30000:30100"

    - name: Create vsftpd user_list file with denied users
      ansible.builtin.copy:
        dest: /etc/vsftpd.user_list
        content: |
          root
          daemon
          bin
          sys
          sync
          games
          man
          lp
          mail
          news
          uucp
          proxy
          www-data
          backup
          list
          irc
          gnats
          nobody
        owner: root
        group: root
        mode: '0644'

    - name: Add local DNS entry for ftp.example.test
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ ftp_pasv_ip }} ftp.example.test"
        state: present

    - name: Start and enable vsftpd service
      ansible.builtin.systemd:
        name: vsftpd
        state: started
        enabled: true
        daemon_reload: true

    - name: Wait for vsftpd to listen on port 21
      ansible.builtin.wait_for:
        host: 0.0.0.0
        port: 21
        delay: 5
        timeout: 30

  handlers:
    - name: Restart vsftpd
      ansible.builtin.systemd:
        name: vsftpd
        state: restarted
